---
# tasks file for install-docker
# RedHat workflows
- name: Remove package on OS ["RedHat", "CentOS"]
  yum:
    name: "{{ item }}"
    state: absent
  loop:
    - docker
    - docker-client
    - docker-client-latest
    - docker-common
    - docker-latest
    - docker-latest-logrotate
    - docker-logrotate
    - docker-engine
    - podman
    - runc
  when: ansible_os_family in ["RedHat", "CentOS"]

- name: Install Prerequisites ["RedHat", "CentOS"]
  yum:
    name: yum-utils
    state: present
  when: ansible_os_family in ["RedHat", "CentOS"]
- name: Add docker repository ["RedHat", "CentOS"]
  yum_repository:
    name: docker-ce-stable
    description: Docker CE Stable - $basearch
    baseurl: https://download.docker.com/linux/rhel/$releasever/$basearch/stable
    enabled: yes
    gpgcheck: yes
    gpgkey: https://download.docker.com/linux/rhel/gpg
  when: ansible_os_family in ["RedHat", "CentOS"]

- name: Install docker ["RedHat", "CentOS"]
  yum:
    name: "{{ item }}"
    state: present
  loop:
    - docker-ce 
    - docker-ce-cli 
    - containerd.io 
    - docker-buildx-plugin 
    - docker-compose-plugin
  when: ansible_os_family in ["RedHat", "CentOS"]

# Docker installation on ubuntu 

- name: remove old package ["Ubuntu", "Debian"]
  apt:
    name: "{{ item }}"
    state: absent
  loop:
    - docker.io 
    - docker-doc 
    - docker-compose 
    - docker-compose-v2 
    - podman-docker 
    - containerd 
    - runc
  when: ansible_os_family in ["Ubuntu", "Debian"]

- name: Update os ["Ubuntu", "Debian"]
  apt:
    name: '*'
    state: present
    update_cache: true
  when: ansible_os_family in ["Ubuntu", "Debian"]
 

- name: Install required system packages ["Ubuntu", "Debian"]
  apt:
    name:
      - ca-certificates
      - curl
    state: present
    update_cache: true
  when: ansible_os_family in ["Ubuntu", "Debian"]

- name: Add Docker repository ["Ubuntu", "Debian"]
  block:
    - name: Download Docker GPG key
      get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: Set permissions for Docker GPG key
      file:
        path: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: Update apt cache
      apt:
        update_cache: yes
  when: ansible_os_family in ["Ubuntu", "Debian"]

- name: Install Docker ["Ubuntu", "Debian"]
  apt:
    name: 
      - docker-ce
      - docker-ce-cli
      - containerd.io
    state: present
  when: ansible_os_family in ["Ubuntu", "Debian"]


- name: Ensure Docker service is running and enabled
  service:
    name: docker
    state: started
    enabled: true
- name: Add user to docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: yes
  notify: Restart Docker service

- name: Apply group changes
  shell: newgrp docker
  changed_when: false
  notify: Restart Docker service

- name: Wait for Docker to be available
  wait_for:
    timeout: 30

- name: Verify Docker access
  command: docker info
  register: docker_info
  changed_when: false